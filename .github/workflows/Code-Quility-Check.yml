name: Code Quality & Validation

on:
  pull_request:
    branches:
      - main
      - develop
    paths:
      - "src/**"
      - "package.json"
      - "package-lock.json"
      - ".eslintrc.cjs"
      - "vite.config.js"
      - ".github/workflows/Code-Quility-Check.yml"
  push:
    branches:
      - main
      - develop

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest
    timeout-minutes: 15

    strategy:
      matrix:
        node-version: ["18.x", "20.x"]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci
        env:
          CI: true

      - name: Lint code with ESLint
        run: npm run lint
        continue-on-error: false

      - name: Build verification
        run: npm run build
        continue-on-error: false
        env:
          CI: true

  dependency-check:
    name: Dependency Security Check
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Audit dependencies
        run: npm audit --audit-level=moderate
        continue-on-error: true

      - name: Check for vulnerable packages
        run: npm audit --production
        continue-on-error: true

  code-analysis:
    name: Code Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Analyze bundle size
        run: npm run build
        env:
          CI: true

  file-validation:
    name: File & Configuration Validation
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"

      - name: Validate JSON files
        run: |
          # Validate package.json
          node -e "JSON.parse(require('fs').readFileSync('package.json', 'utf8'))" && echo "‚úì package.json is valid"

          # Validate tsconfig.json
          node -e "JSON.parse(require('fs').readFileSync('tsconfig.json', 'utf8'))" && echo "‚úì tsconfig.json is valid"

          # Validate public config files
          if [ -f "public/manifest.json" ]; then
            node -e "JSON.parse(require('fs').readFileSync('public/manifest.json', 'utf8'))" && echo "‚úì manifest.json is valid"
          fi
        continue-on-error: true

      - name: Check for large files
        run: |
          echo "Checking for files larger than 5MB..."
          find . -type f -size +5M ! -path "./node_modules/*" ! -path "./.git/*" ! -path "./dist/*" || echo "No large files found"

  lint-summary:
    name: Lint Summary
    runs-on: ubuntu-latest
    needs: [code-quality]
    if: always()
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Generate detailed lint report
        run: |
          npx eslint ./src --ext js,jsx --format=json > eslint-report.json || true
          npx eslint ./src --ext js,jsx --format=stylish
        continue-on-error: true

      - name: Upload lint report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: eslint-report
          path: eslint-report.json
          retention-days: 30

  pr-comment:
    name: PR Status Report
    runs-on: ubuntu-latest
    needs: [code-quality, dependency-check, code-analysis, file-validation]
    if: github.event_name == 'pull_request' && always()
    timeout-minutes: 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Prepare status report
        id: report
        run: |
          echo "## üîç Code Quality Check Report" > report.md
          echo "" >> report.md

          # Code Quality Status
          if [[ "${{ needs.code-quality.result }}" == "success" ]]; then
            echo "‚úÖ **Code Quality**: PASSED" >> report.md
          else
            echo "‚ùå **Code Quality**: FAILED" >> report.md
          fi

          # Dependency Check Status
          if [[ "${{ needs.dependency-check.result }}" == "success" ]]; then
            echo "‚úÖ **Dependency Security**: PASSED" >> report.md
          else
            echo "‚ö†Ô∏è **Dependency Security**: CHECK WARNINGS" >> report.md
          fi

          # Build Status
          echo "‚úÖ **Build**: PASSED" >> report.md
          echo "" >> report.md

          # Checklist
          echo "### Quality Checks" >> report.md
          echo "- ‚úì ESLint validation" >> report.md
          echo "- ‚úì Build verification" >> report.md
          echo "- ‚úì Dependency audit" >> report.md
          echo "- ‚úì File validation" >> report.md

          cat report.md

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('report.md', 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });

  final-status:
    name: Workflow Status
    runs-on: ubuntu-latest
    needs: [code-quality, dependency-check, code-analysis, file-validation]
    if: always()
    timeout-minutes: 2

    steps:
      - name: Determine workflow status
        run: |
          if [[ "${{ needs.code-quality.result }}" != "success" ]]; then
            echo "‚ùå Code Quality Check failed"
            exit 1
          fi

          if [[ "${{ needs.code-analysis.result }}" != "success" ]]; then
            echo "‚ùå Code Analysis failed"
            exit 1
          fi

          if [[ "${{ needs.file-validation.result }}" != "success" ]]; then
            echo "‚ùå File Validation failed"
            exit 1
          fi

          echo "‚úÖ All checks passed successfully!"
